<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æœºç•™è¨€ç¤¾åŒº</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 0 0 60px 0;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 10px;
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        textarea.form-input {
            min-height: 100px;
            resize: vertical;
        }
        
        .submit-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 1rem;
        }
        
        .message {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }
        
        .message:last-child {
            border-bottom: none;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .message-author {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .message-date {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .message-content {
            margin-bottom: 10px;
        }
        
        .message-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            background: none;
            border: 1px solid #ddd;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .action-btn.liked {
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            width: 100%;
            max-width: 500px;
            border-radius: 8px;
            padding: 20px;
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            right: 15px;
            top: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }
        
        .nav-item {
            text-align: center;
            font-size: 0.8rem;
        }
        
        .nav-item.active {
            color: #3498db;
        }
        
        .fab {
            position: fixed;
            bottom: 70px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .toast {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            z-index: 1001;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab-button {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            cursor: pointer;
        }
        
        .tab-button.active {
            border-bottom: 2px solid #3498db;
            color: #3498db;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .replies {
            margin: 10px 0;
            padding-left: 15px;
            border-left: 2px solid #eee;
        }
        
        .reply {
            padding: 10px 0;
            border-bottom: 1px solid #f5f5f5;
        }
        
        .reply:last-child {
            border-bottom: none;
        }
        
        .reply-form {
            display: none;
            margin-top: 10px;
        }
        
        .reply-form.active {
            display: block;
        }
        
        .admin-badge, .user-badge {
            display: inline-block;
            background: #e74c3c;
            color: white;
            font-size: 0.7rem;
            padding: 2px 5px;
            border-radius: 3px;
            margin-left: 5px;
        }
        
        .user-badge {
            background: #3498db;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <nav class="navbar">
                <div class="logo">ç•™è¨€ç¤¾åŒº</div>
                <div>
                    <button id="userAuthBtn" class="btn">ç™»å½•/æ³¨å†Œ</button>
                    <button id="adminLoginBtn" class="btn">ç®¡ç†å‘˜</button>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <section id="userPanel" class="card" style="display: none;">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div>
                    <h3 id="userName">ç”¨æˆ·</h3>
                    <p id="userEmail" style="color: #666; font-size: 0.9rem;">user@example.com</p>
                </div>
            </div>
            <button id="logoutBtn" class="submit-btn btn-danger">é€€å‡ºç™»å½•</button>
        </section>

        <section id="adminPanel" class="card" style="display: none;">
            <h2>ç®¡ç†å‘˜é¢æ¿</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0;">
                <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold;" id="totalMessages">0</div>
                    <div style="font-size: 0.8rem; color: #666;">æ€»ç•™è¨€æ•°</div>
                </div>
                <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold;" id="totalReplies">0</div>
                    <div style="font-size: 0.8rem; color: #666;">æ€»å›å¤æ•°</div>
                </div>
            </div>
            <button id="logoutAdminBtn" class="submit-btn btn-danger">é€€å‡ºç®¡ç†å‘˜</button>
        </section>

        <section class="card">
            <h1 id="welcomeTitle">æ¬¢è¿æ¥åˆ°ç•™è¨€ç¤¾åŒº</h1>
            <p id="welcomeText">åœ¨è¿™é‡Œåˆ†äº«æƒ³æ³•ã€äº¤æµè§‚ç‚¹ï¼Œä¸ç¤¾åŒºæˆå‘˜äº’åŠ¨ã€‚</p>
        </section>

        <div style="position: relative; margin: 15px 0;">
            <input type="text" id="searchInput" class="form-input" placeholder="æœç´¢ç•™è¨€...">
        </div>

        <section class="card">
            <h2>ç¤¾åŒºç•™è¨€</h2>
            <div id="messagesList" style="max-height: 400px; overflow-y: auto;">
                <!-- ç•™è¨€å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
            </div>
        </section>
    </main>

    <nav class="bottom-nav">
        <div class="nav-item active" data-tab="messages">
            <div>é¦–é¡µ</div>
        </div>
        <div class="nav-item" data-tab="hot">
            <div>çƒ­é—¨</div>
        </div>
        <div class="nav-item" data-tab="profile">
            <div>æˆ‘çš„</div>
        </div>
    </nav>

    <button class="fab" id="fabBtn">+</button>

    <!-- ç•™è¨€è¡¨å•æ¨¡æ€æ¡† -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <button id="closeMessageModal" class="close-modal">Ã—</button>
            <h2>å‘å¸ƒæ–°ç•™è¨€</h2>
            <form id="messageForm">
                <div class="form-group">
                    <textarea id="messageContent" class="form-input" placeholder="è¯·è¾“å…¥æ‚¨çš„ç•™è¨€å†…å®¹..." required maxlength="500"></textarea>
                </div>
                <button type="submit" class="submit-btn">å‘å¸ƒç•™è¨€</button>
            </form>
        </div>
    </div>

    <!-- ç”¨æˆ·ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡† -->
    <div id="userAuthModal" class="modal">
        <div class="modal-content">
            <button id="closeUserAuthModal" class="close-modal">Ã—</button>
            <h2>ç”¨æˆ·ç™»å½•/æ³¨å†Œ</h2>
            
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="login">ç™»å½•</button>
                <button class="tab-button" data-tab="register">æ³¨å†Œ</button>
            </div>
            
            <form id="loginForm" class="tab-content active">
                <div class="form-group">
                    <input type="email" id="loginEmail" class="form-input" placeholder="é‚®ç®±" required>
                </div>
                <div class="form-group">
                    <input type="password" id="loginPassword" class="form-input" placeholder="å¯†ç " required>
                </div>
                <button type="submit" class="submit-btn">ç™»å½•</button>
            </form>
            
            <form id="registerForm" class="tab-content">
                <div class="form-group">
                    <input type="text" id="registerName" class="form-input" placeholder="ç”¨æˆ·å" required maxlength="20">
                </div>
                <div class="form-group">
                    <input type="email" id="registerEmail" class="form-input" placeholder="é‚®ç®±" required>
                </div>
                <div class="form-group">
                    <input type="password" id="registerPassword" class="form-input" placeholder="å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" required minlength="6">
                </div>
                <div class="form-group">
                    <input type="password" id="confirmPassword" class="form-input" placeholder="ç¡®è®¤å¯†ç " required minlength="6">
                </div>
                <button type="submit" class="submit-btn">æ³¨å†Œ</button>
            </form>
        </div>
    </div>

    <!-- ç®¡ç†å‘˜ç™»å½•æ¨¡æ€æ¡† -->
    <div id="adminLoginModal" class="modal">
        <div class="modal-content">
            <button id="closeAdminModal" class="close-modal">Ã—</button>
            <h2>ç®¡ç†å‘˜ç™»å½•</h2>
            <form id="adminLoginForm">
                <div class="form-group">
                    <input type="text" id="adminUsername" class="form-input" placeholder="ç®¡ç†å‘˜ç”¨æˆ·å" required>
                </div>
                <div class="form-group">
                    <input type="password" id="adminPassword" class="form-input" placeholder="ç®¡ç†å‘˜å¯†ç " required>
                </div>
                <button type="submit" class="submit-btn">ç™»å½•</button>
            </form>
            <p style="margin-top: 1rem; font-size: 0.9rem; color: #666; text-align: center;">
                æç¤ºï¼šé»˜è®¤ç®¡ç†å‘˜è´¦å· admin / 123456
            </p>
        </div>
    </div>

    <script>
        // ç•™è¨€ç¤¾åŒºåº”ç”¨
        function MobileMessageBoard() {
            // åº”ç”¨çŠ¶æ€
            this.messages = this.loadMessages();
            this.users = this.loadUsers();
            this.isAdmin = localStorage.getItem('isAdmin') === 'true' || false;
            this.currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
            this.currentTab = 'messages';
            this.filteredMessages = this.messages.slice();
            this.debounceTimer = null;
            
            this.init();
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        MobileMessageBoard.prototype.init = function() {
            this.bindEvents();
            this.renderMessages();
            this.updateUI();
        };
        
        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        MobileMessageBoard.prototype.bindEvents = function() {
            var self = this;
            
            // æ¨¡æ€æ¡†æ§åˆ¶
            document.getElementById('fabBtn').addEventListener('click', function() {
                if (self.currentUser) {
                    self.showModal('messageModal');
                } else {
                    self.showToast('è¯·å…ˆç™»å½•åå†å‘å¸ƒç•™è¨€');
                    self.showModal('userAuthModal');
                }
            });
            
            // æ¨¡æ€æ¡†å…³é—­æŒ‰é’®
            document.getElementById('closeMessageModal').addEventListener('click', function() {
                self.hideModal('messageModal');
            });
            
            document.getElementById('closeUserAuthModal').addEventListener('click', function() {
                self.hideModal('userAuthModal');
            });
            
            document.getElementById('closeAdminModal').addEventListener('click', function() {
                self.hideModal('adminLoginModal');
            });
            
            // è¡¨å•æäº¤
            document.getElementById('messageForm').addEventListener('submit', function(e) {
                e.preventDefault();
                self.handleMessageSubmit(e);
            });
            
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                self.handleLogin(e);
            });
            
            document.getElementById('registerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                self.handleRegister(e);
            });
            
            document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                self.handleAdminLogin(e);
            });
            
            // ç”¨æˆ·è®¤è¯æŒ‰é’®
            document.getElementById('userAuthBtn').addEventListener('click', function() {
                if (self.currentUser) {
                    self.logoutUser();
                } else {
                    self.showModal('userAuthModal');
                }
            });
            
            document.getElementById('adminLoginBtn').addEventListener('click', function() {
                if (self.isAdmin) {
                    self.logoutAdmin();
                } else {
                    self.showModal('adminLoginModal');
                }
            });
            
            // é€€å‡ºç™»å½•æŒ‰é’®
            document.getElementById('logoutBtn').addEventListener('click', function() {
                self.logoutUser();
            });
            
            document.getElementById('logoutAdminBtn').addEventListener('click', function() {
                self.logoutAdmin();
            });
            
            // æœç´¢æ¡†
            document.getElementById('searchInput').addEventListener('input', function(e) {
                self.handleSearch(e.target.value);
            });
            
            // æ¨¡æ€æ¡†å¤–éƒ¨ç‚¹å‡»å…³é—­
            var modals = document.querySelectorAll('.modal');
            for (var i = 0; i < modals.length; i++) {
                modals[i].addEventListener('click', function(e) {
                    if (e.target === this) {
                        self.hideModal(this.id);
                    }
                });
            }
            
            // ç•™è¨€åˆ—è¡¨äº‹ä»¶å§”æ‰˜
            document.getElementById('messagesList').addEventListener('click', function(e) {
                self.handleMessageAction(e);
            });
            
            // åº•éƒ¨å¯¼èˆªåˆ‡æ¢
            var navItems = document.querySelectorAll('.nav-item');
            for (var i = 0; i < navItems.length; i++) {
                navItems[i].addEventListener('click', function(e) {
                    self.switchTab(this.getAttribute('data-tab'));
                });
            }
            
            // ç™»å½•/æ³¨å†Œæ ‡ç­¾åˆ‡æ¢
            var tabButtons = document.querySelectorAll('.tab-button');
            for (var i = 0; i < tabButtons.length; i++) {
                tabButtons[i].addEventListener('click', function(e) {
                    self.switchAuthTab(this.getAttribute('data-tab'));
                });
            }
            
            // é”®ç›˜äº‹ä»¶
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    self.hideAllModals();
                }
            });
        };
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ç•™è¨€æ•°æ®
        MobileMessageBoard.prototype.loadMessages = function() {
            try {
                var stored = localStorage.getItem('messages');
                return stored ? JSON.parse(stored) : this.getDefaultMessages();
            } catch (e) {
                console.error('è§£æç•™è¨€æ•°æ®å¤±è´¥:', e);
                this.showToast('æ•°æ®åŠ è½½å¤±è´¥ï¼Œå·²æ¢å¤é»˜è®¤æ•°æ®');
                return this.getDefaultMessages();
            }
        };
        
        // è·å–é»˜è®¤ç•™è¨€æ•°æ®
        MobileMessageBoard.prototype.getDefaultMessages = function() {
            return [
                {
                    id: 1,
                    author: "ç¤¾åŒºç”¨æˆ·",
                    content: "æ¬¢è¿æ¥åˆ°ç•™è¨€ç¤¾åŒºï¼è¿™æ˜¯ä¸€ä¸ªç®€æ´çš„æ‰‹æœºç‰ˆç•™è¨€æ¿åº”ç”¨ã€‚",
                    date: this.formatDate(new Date()),
                    likes: 3,
                    liked: false,
                    userId: "default1",
                    replies: [
                        {
                            id: 101,
                            author: "æå››",
                            content: "è¿™ä¸ªç•™è¨€æ¿è®¾è®¡å¾—å¾ˆä¸é”™ï¼",
                            date: this.formatDate(new Date(Date.now() - 3600000)),
                            userId: "default2"
                        }
                    ]
                },
                {
                    id: 2,
                    author: "å¼ ä¸‰",
                    content: "ä»Šå¤©å¤©æ°”çœŸå¥½ï¼Œé€‚åˆæˆ·å¤–æ´»åŠ¨ï¼",
                    date: this.formatDate(new Date(Date.now() - 7200000)),
                    likes: 1,
                    liked: false,
                    userId: "default3",
                    replies: []
                }
            ];
        };
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ç”¨æˆ·æ•°æ®
        MobileMessageBoard.prototype.loadUsers = function() {
            try {
                var stored = localStorage.getItem('users');
                return stored ? JSON.parse(stored) : this.getDefaultUsers();
            } catch (e) {
                console.error('è§£æç”¨æˆ·æ•°æ®å¤±è´¥:', e);
                return this.getDefaultUsers();
            }
        };
        
        // è·å–é»˜è®¤ç”¨æˆ·æ•°æ®
        MobileMessageBoard.prototype.getDefaultUsers = function() {
            return [
                {
                    id: "default1",
                    name: "ç¤¾åŒºç”¨æˆ·",
                    email: "user1@example.com",
                    password: "123456",
                    joinDate: new Date().toISOString()
                },
                {
                    id: "default2",
                    name: "æå››",
                    email: "user2@example.com",
                    password: "123456",
                    joinDate: new Date().toISOString()
                },
                {
                    id: "default3",
                    name: "å¼ ä¸‰",
                    email: "user3@example.com",
                    password: "123456",
                    joinDate: new Date().toISOString()
                }
            ];
        };
        
        // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
        MobileMessageBoard.prototype.formatDate = function(date) {
            var now = new Date();
            var diff = now - date;
            
            if (diff < 60000) return 'åˆšåˆš';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'å¤©å‰';
            
            return date.getFullYear() + 'å¹´' + 
                   (date.getMonth() + 1) + 'æœˆ' + 
                   date.getDate() + 'æ—¥ ' + 
                   this.padZero(date.getHours()) + ':' + 
                   this.padZero(date.getMinutes());
        };
        
        // è¡¥é›¶å‡½æ•°
        MobileMessageBoard.prototype.padZero = function(num) {
            return num < 10 ? '0' + num : num;
        };
        
        // æ¸²æŸ“ç•™è¨€åˆ—è¡¨
        MobileMessageBoard.prototype.renderMessages = function() {
            var container = document.getElementById('messagesList');
            
            if (this.filteredMessages.length === 0) {
                container.innerHTML = this.getEmptyStateHTML();
                return;
            }
            
            var html = '';
            for (var i = 0; i < this.filteredMessages.length; i++) {
                html += this.getMessageHTML(this.filteredMessages[i]);
            }
            
            container.innerHTML = html;
            
            // ç»‘å®šå›å¤è¡¨å•äº‹ä»¶
            this.bindReplyEvents();
        };
        
        // è·å–ç©ºçŠ¶æ€HTML
        MobileMessageBoard.prototype.getEmptyStateHTML = function() {
            var icons = { messages: 'ğŸ’¬', hot: 'ğŸ”¥', profile: 'ğŸ‘¤' };
            var messages = {
                messages: 'æš‚æ— ç•™è¨€',
                hot: 'æš‚æ— çƒ­é—¨ç•™è¨€',
                profile: 'ä¸ªäººä¸­å¿ƒ'
            };
            
            return '<div class="empty-state">' +
                   '<div class="empty-state-icon">' + (icons[this.currentTab] || 'ğŸ’¬') + '</div>' +
                   '<p>' + (messages[this.currentTab] || 'æš‚æ— å†…å®¹') + '</p>' +
                   '<p style="margin-top: 16px; font-size: 0.9rem; color: #7f8c8d;">' +
                   (this.currentTab === 'profile' && !this.currentUser ? 
                    'è¯·å…ˆç™»å½•æŸ¥çœ‹ä¸ªäººä¿¡æ¯' : 'å¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡ç•™è¨€å§ï¼') +
                   '</p>' +
                   (this.currentTab === 'profile' && !this.currentUser ? 
                    '<button id="loginFromProfile" class="submit-btn" style="margin-top: 16px;">ç«‹å³ç™»å½•</button>' : '') +
                   '</div>';
        };
        
        // è·å–ç•™è¨€HTML
        MobileMessageBoard.prototype.getMessageHTML = function(message) {
            var isCurrentUserMessage = this.currentUser && message.userId === this.currentUser.id;
            var isAdminMessage = message.author === 'admin';
            
            var repliesHTML = '';
            if (message.replies && message.replies.length > 0) {
                repliesHTML = '<div class="replies">';
                for (var i = 0; i < message.replies.length; i++) {
                    var reply = message.replies[i];
                    var isCurrentUserReply = this.currentUser && reply.userId === this.currentUser.id;
                    var isAdminReply = reply.author === 'admin';
                    
                    repliesHTML += '<div class="reply">' +
                        '<div class="message-header">' +
                        '<div class="message-author">' +
                        this.escapeHtml(reply.author) +
                        (isAdminReply ? '<span class="admin-badge">ç®¡ç†å‘˜</span>' : '') +
                        (isCurrentUserReply ? '<span class="user-badge">æˆ‘</span>' : '') +
                        '</div>' +
                        '<div class="message-date">' + this.escapeHtml(reply.date) + '</div>' +
                        '</div>' +
                        '<div class="message-content">' + this.escapeHtml(reply.content) + '</div>' +
                        ((this.isAdmin || isCurrentUserReply) ? 
                        '<button class="action-btn delete-btn delete-reply-btn" data-message-id="' + message.id + '" data-reply-id="' + reply.id + '">åˆ é™¤å›å¤</button>' : '') +
                        '</div>';
                }
                repliesHTML += '</div>';
            }
            
            return '<div class="message" data-id="' + message.id + '">' +
                '<div class="message-header">' +
                '<div class="message-author">' +
                this.escapeHtml(message.author) +
                (isAdminMessage ? '<span class="admin-badge">ç®¡ç†å‘˜</span>' : '') +
                (isCurrentUserMessage ? '<span class="user-badge">æˆ‘</span>' : '') +
                '</div>' +
                '<div class="message-date">' + this.escapeHtml(message.date) + '</div>' +
                '</div>' +
                '<div class="message-content">' + this.escapeHtml(message.content) + '</div>' +
                repliesHTML +
                '<div class="message-actions">' +
                '<button class="action-btn like-btn ' + (message.liked ? 'liked' : '') + '" data-id="' + message.id + '">' +
                'èµ (' + message.likes + ')' +
                '</button>' +
                '<button class="action-btn reply-btn" data-id="' + message.id + '">å›å¤</button>' +
                ((this.isAdmin || isCurrentUserMessage) ? 
                '<button class="action-btn delete-btn delete-message-btn" data-id="' + message.id + '">åˆ é™¤</button>' : '') +
                '</div>' +
                '<form class="reply-form" data-message-id="' + message.id + '">' +
                '<div class="form-group">' +
                '<textarea class="form-input reply-content" placeholder="å›å¤å†…å®¹..." required maxlength="300"></textarea>' +
                '</div>' +
                '<div style="display: flex; gap: 8px;">' +
                '<button type="submit" class="submit-btn" style="flex: 1;">æäº¤å›å¤</button>' +
                '<button type="button" class="submit-btn cancel-reply-btn" style="background-color: #95a5a6; flex: 0.5;">å–æ¶ˆ</button>' +
                '</div>' +
                '</form>' +
                '</div>';
        };
        
        // ç»‘å®šå›å¤ç›¸å…³äº‹ä»¶
        MobileMessageBoard.prototype.bindReplyEvents = function() {
            var self = this;
            
            // å›å¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            var replyBtns = document.querySelectorAll('.reply-btn');
            for (var i = 0; i < replyBtns.length; i++) {
                replyBtns[i].addEventListener('click', function(e) {
                    if (!self.currentUser) {
                        self.showToast('è¯·å…ˆç™»å½•åå†å›å¤');
                        self.showModal('userAuthModal');
                        return;
                    }
                    
                    var messageId = parseInt(this.getAttribute('data-id'));
                    var messageElement = this.closest('.message');
                    var replyForm = messageElement.querySelector('.reply-form');
                    replyForm.classList.toggle('active');
                });
            }
            
            // å–æ¶ˆå›å¤æŒ‰é’®
            var cancelReplyBtns = document.querySelectorAll('.cancel-reply-btn');
            for (var i = 0; i < cancelReplyBtns.length; i++) {
                cancelReplyBtns[i].addEventListener('click', function(e) {
                    var replyForm = this.closest('.reply-form');
                    replyForm.classList.remove('active');
                    replyForm.reset();
                });
            }
            
            // å›å¤è¡¨å•æäº¤
            var replyForms = document.querySelectorAll('.reply-form');
            for (var i = 0; i < replyForms.length; i++) {
                replyForms[i].addEventListener('submit', function(e) {
                    e.preventDefault();
                    self.handleReplySubmit(e);
                });
            }
            
            // åˆ é™¤æŒ‰é’®äº‹ä»¶
            if (this.isAdmin || this.currentUser) {
                var deleteMessageBtns = document.querySelectorAll('.delete-message-btn');
                for (var i = 0; i < deleteMessageBtns.length; i++) {
                    deleteMessageBtns[i].addEventListener('click', function(e) {
                        var messageId = parseInt(this.getAttribute('data-id'));
                        self.deleteMessage(messageId);
                    });
                }
                
                var deleteR